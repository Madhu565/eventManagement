require("dotenv").config();const express=require("express"),bodyParser=require("body-parser"),ejs=require("ejs"),mongoose=require("mongoose"),passport=require("passport"),session=require("express-session"),passportLocalMongoose=require("passport-local-mongoose"),multer=require("multer");var fs=require("fs"),nodemailer=require("nodemailer"),path=require("path");const app=express();app.set("view engine","ejs"),app.use(bodyParser.urlencoded({extended:!0})),app.use(express.static("public")),app.use(session({secret:"secret",resave:!1,saveUninitialized:!1})),app.use(passport.initialize()),app.use(passport.session()),mongoose.connect(`mongodb+srv://${process.env.ADMIN}:${process.env.PASSWORD}@cluster0.eyjhl.mongodb.net/projectDB`,{useUnifiedTopology:!0,useNewUrlParser:!0});const eventSchema=new mongoose.Schema({username:String,organizerName:String,eventName:String,description:String,location:String,tolalCapacity:Number,startDate:Number,startTime:String,endDate:Number,endTime:String,price:Number,city:String,image:{data:Buffer,contentType:String},Booked:Number}),Event=mongoose.model("Event",eventSchema),audianceSchema=new mongoose.Schema({audiName:String,audiEmail:String,audiPhNum:Number,audiAge:Number,audiAddress:String,eventId:String,noOfTickets:Number,gender:String}),Audiance=mongoose.model("AudianceDetail",audianceSchema),organiserSchema=new mongoose.Schema({username:String,name:String,email:String,password:String});organiserSchema.plugin(passportLocalMongoose);const Organiser=mongoose.model("Organiser",organiserSchema);function dateToNumber(e){let n=[];for(let t=0;t<e.length;t++)"-"!=e[t]&&n.push(e[t]);let t=n.join("");return Number(t)}function handleError(e){}function today(){let e=new Date,n=e.getDate(),t=e.getMonth()+1,a=e.getFullYear();return`${a}-0${t}-${n}`}passport.use(Organiser.createStrategy()),passport.serializeUser(Organiser.serializeUser()),passport.deserializeUser(Organiser.deserializeUser()),app.get("/",((e,n)=>{n.render("landing")})),app.get("/organiser",(function(e,n){e.isAuthenticated()?Event.find({username:e.user.username},(function(t,a){if(t);else{var r=e.user.name;n.render("organiser",{passedname:r,foundEvents:a})}})):n.redirect("/login"),Event.deleteMany({endDate:{$lte:dateToNumber(today())}},(e=>{}))})),app.get("/createEvent",(function(e,n){n.render("createEvent")})),app.get("/pictures",(function(e,n){Event.find({image:{$ne:null}},(function(e,t){e||t&&n.render("pictures",{items:t})}))}));var Storage=multer.diskStorage({destination:"./public/uploads/",filename:(e,n,t)=>{t(null,n.fieldname+"_"+Date.now())}}),upload=multer({storage:Storage}).single("file");app.post("/createEvent",upload,(function(e,n){new Event({username:e.user.username,eventName:e.body.Name,description:e.body.description,location:e.body.location,tolalCapacity:e.body.capacity,startDate:dateToNumber(e.body.startDate),startTime:e.body.startTime,endDate:dateToNumber(e.body.endDate),endTime:e.body.endTime,price:e.body.price,city:e.body.city,Booked:0,image:{data:fs.readFileSync(path.join("./public/uploads/"+e.file.filename)),contentType:"image/png"}}).save((function(e,t){if(e)throw e;n.redirect("/organiser")}))})),app.post("/delete",(function(e,n){var t=e.body.id;Event.deleteOne({_id:t},(function(e){})),n.redirect("organiser")})),app.get("/cities/:city",((e,n)=>{const t=e.params.city;Event.find({city:t},((e,t)=>{e||n.render("events",{foundEvents:t})}))})),app.get("/cities/:city/:eventId",((e,n)=>{const t=e.params.eventId,a=e.params.city;Event.find({city:a,_id:t},((e,t)=>{e||n.render("eventDetails",{foundEvent:t})}))})),app.get("/analytics/:id",(function(e,n){const t=e.params.id;let a=0,r=0,i=0,o=0,s=0,d=0,u=[];Event.find({_id:t},(function(e,n){e||(u=n)})).then((()=>{Audiance.find({eventId:t},(function(e,t){e||(t.forEach((function(e){"Male"===e.gender&&(a+=1),"Female"===e.gender&&(r+=1),e.audiAge>=0&&e.audiAge<=14&&(i+=1),e.audiAge>14&&e.audiAge<=24&&(o+=1),e.audiAge>24&&e.audiAge<=64&&(s+=1),e.audiAge>64&&(d+=1)})),n.render("analytics",{passedAudience:t,male:a,female:r,children:i,teenager:o,middleAged:s,seniorCitizen:d,booking:u[0].Booked,cap:u[0].tolalCapacity}))}))}))})),app.get("/cities/:city",((e,n)=>{const t=e.params.city;Event.deleteMany({endDate:{$lte:dateToNumber(today())}},(e=>{})),Event.find({city:t},((e,t)=>{e||n.render("events",{foundEvents:t})}))})),app.get("/events",((e,n)=>{Event.find({},((e,t)=>{e||n.json(t)}))})),app.post("/audiDetailsInput",((e,n)=>{const{AudiName:t,email:a,ph_num:r,age:i,address:o,id:s,tickets:d,gender:u}=e.body;new Audiance({audiName:t,audiEmail:a,audiPhNum:r,audiAge:i,audiAddress:o,eventId:s,noOfTickets:d,gender:u}).save(),Event.findById(s,((e,n)=>{n.Booked=Number(n.Booked)+Number(d),n.save(((e,n)=>{}))})),n.render("audiBookConfirm",{AudiName:t});var c=nodemailer.createTransport({service:"gmail",auth:{user:"grabmyseatSquad@gmail.com",pass:`${process.env.NODEMAILERPASSWORD}`}}),p={from:"grabmyseatSquad@gmail.com",to:e.body.email,subject:"Test Email",text:"Thanks for contacting GRAB MY SEAT"};c.sendMail(p,(function(e,n){}))})),app.get("/cities/:city/:eventId/booking",((e,n)=>{const t=e.params.city,a=e.params.eventId;Event.find({city:t,_id:a},((e,t)=>{if(e);else{var a=t[0].tolalCapacity-t[0].Booked;n.render("audiDetailsInput",{foundEvent:t,remain:a})}}))})),app.get("/register",(function(e,n){n.render("register")})),app.post("/register",(function(e,n){Organiser.register({username:e.body.username,name:e.body.name,email:e.body.email},e.body.password,(function(t,a){t?n.redirect("/register"):passport.authenticate("local")(e,n,(function(){n.redirect("/organiser");var t=nodemailer.createTransport({service:"gmail",auth:{user:"grabmyseatSquad@gmail.com",pass:`${process.env.NODEMAILERPASSWORD}`}}),a={from:"grabmyseatSquad@gmail.com",to:e.body.email,subject:"Test Email",text:"Thanks for contacting GRAB MY SEAT"};t.sendMail(a,(function(e,n){}))}))}))})),app.get("/login",((e,n)=>{n.render("login")})),app.post("/login",(function(e,n){const t=new Organiser({username:e.body.username,password:e.body.password});e.login(t,(function(t){t||passport.authenticate("local",{failureRedirect:"/login"})(e,n,(function(){n.redirect("/organiser")}))}))})),app.get("/logout",(function(e,n){e.logout(),n.redirect("/")})),app.listen(3e3,(()=>{}));