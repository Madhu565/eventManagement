require("dotenv").config();const express=require("express"),bodyParser=require("body-parser"),ejs=require("ejs"),mongoose=require("mongoose"),passport=require("passport"),session=require("express-session"),passportLocalMongoose=require("passport-local-mongoose"),multer=require("multer"),PDFDocument=require("pdfkit");var fs=require("fs"),nodemailer=require("nodemailer"),path=require("path");const app=express();app.set("view engine","ejs"),app.use(bodyParser.urlencoded({extended:!0})),app.use(express.static("public")),app.use(session({secret:"secret",resave:!1,saveUninitialized:!1})),app.use(passport.initialize()),app.use(passport.session()),mongoose.connect(`mongodb+srv://${process.env.ADMIN}:${process.env.PASSWORD}@cluster0.eyjhl.mongodb.net/projectDB`,{useUnifiedTopology:!0,useNewUrlParser:!0});const eventSchema=new mongoose.Schema({username:String,organizerName:String,eventName:String,description:String,location:String,tolalCapacity:Number,startDate:Number,startTime:String,endDate:Number,endTime:String,price:Number,city:String,image:{data:Buffer,contentType:String},Booked:Number,BookedPer:Number,eventType:String}),Event=mongoose.model("Event",eventSchema),audianceSchema=new mongoose.Schema({audiName:String,audiEmail:String,audiAge:Number,eventId:String,noOfTickets:Number,audiPhNum:Number,gender:String}),Audiance=mongoose.model("AudianceDetail",audianceSchema),organiserSchema=new mongoose.Schema({username:String,name:String,email:String,password:String,role:String,audiPhNum:Number,gender:String,audiAge:Number,prefEvent:String});organiserSchema.plugin(passportLocalMongoose);const Organiser=mongoose.model("Organiser",organiserSchema);passport.use(Organiser.createStrategy()),passport.serializeUser(Organiser.serializeUser()),passport.deserializeUser(Organiser.deserializeUser());const collegeEventSchema=new mongoose.Schema({username:String,eventName:String,description:String,location:String,startDate:Number,startTime:String,endDate:Number,endTime:String,price:Number,collegeName:String,type:String,image:{data:Buffer,contentType:String},Booked:Number,rules:String}),CollegeEvent=mongoose.model("CollegeEvent",collegeEventSchema);function dateToNumber(e){let n=[];for(let t=0;t<e.length;t++)"-"!=e[t]&&n.push(e[t]);let t=n.join("");return Number(t)}function handleError(e){}function numberToDate(e){let n=[];for(let t=0;t<e.length;t++)3==t||5==t?(n.push(e[t]),n.push("-")):n.push(e[t]);return n.join("")}function today(){let e=new Date,n=e.getDate(),t=e.getMonth()+1,r=e.getFullYear();return`${r}-0${t}-${n}`}app.get("/",((e,n)=>{e.url;n.render("landing")})),app.get("/organiser",(function(e,n){if(e.isAuthenticated()){var t=e.user.name,r=[];Event.deleteMany({endDate:{$lte:dateToNumber(today())}},(e=>{})).then((()=>{Event.find({username:e.user.username},(function(n,t){if(n);else{e.user.name;r=t}})).then((()=>{CollegeEvent.deleteMany({endDate:{$lte:dateToNumber(today())}},(e=>{})).then((()=>{CollegeEvent.find({username:e.user.username},(function(e,a){e?handleError(e):n.render("organiser",{passedname:t,arr:r,foundcolEvents:a})}))}))}))}))}else n.redirect("/login")}));var Storage=multer.diskStorage({destination:"./public/uploads/",filename:(e,n,t)=>{t(null,n.fieldname+"_"+Date.now())}}),upload=multer({storage:Storage}).single("file");app.get("/createEvent",(function(e,n){var t=e.user.username;n.render("createEvent",{username:t})})),app.get("/pictures",(function(e,n){Event.find({image:{$ne:null}},(function(e,t){e||t&&n.render("pictures",{items:t})}))})),app.post("/createEvent",upload,(function(e,n){new Event({username:e.body.username,eventName:e.body.Name,description:e.body.description,location:e.body.location,tolalCapacity:e.body.capacity,startDate:dateToNumber(e.body.startDate),startTime:e.body.startingTime,endDate:dateToNumber(e.body.endDate),endTime:e.body.endTime,price:e.body.price,city:e.body.city,eventType:e.body.eventType,Booked:0,BookedPer:0,image:{data:fs.readFileSync(path.join("./public/uploads/"+e.file.filename)),contentType:"image/png"}}).save((function(e,t){if(e)throw e;n.redirect("/organiser")}))})),app.post("/delete",(function(e,n){var t=e.body.id;Event.deleteOne({_id:t},(function(e){})),CollegeEvent.deleteOne({_id:t},(function(e){e&&handleError(e)})),n.redirect("organiser")})),app.get("/collegeEventform",(function(e,n){var t=e.user.username;n.render("collegeEventform",{username:t})})),app.post("/collegeEvent",upload,(function(e,n){new CollegeEvent({username:e.body.username,eventName:e.body.Name,description:e.body.description,location:e.body.location,startDate:dateToNumber(e.body.startDate),startTime:e.body.startingTime,endDate:dateToNumber(e.body.endDate),endTime:e.body.endTime,price:e.body.price,collegeName:e.body.colName,rules:e.body.rules,type:e.body.type,image:{data:fs.readFileSync(path.join("./public/uploads/"+e.file.filename)),contentType:"image/png"}}).save((function(e,t){e||n.redirect("/collegeEventform")}))})),app.get("/collegeEvents/:id",((e,n)=>{if(e.isAuthenticated()){const t=e.user,r=e.params.id;CollegeEvent.find({_id:r},((e,r)=>{n.render("collegeEvent",{foundEvent:r,user:t,startDate:numberToDate(String(r[0].startDate)),endDate:numberToDate(String(r[0].endDate))})}))}else n.redirect("/audilogin")})),app.post("/collegeBook",(function(e,n){new Audiance({audiName:e.body.name,eventId:e.body.id,audiEmail:e.body.mail,audiAge:e.body.age,audiPhNum:e.body.phnum,type:e.body.type}).save(),n.render("audiBookConfirm")})),app.get("/cities/:city/",((e,n)=>{const t=e.params.city;Event.find({city:t},((e,r)=>{e||n.render("events",{foundEvents:r,requestedCity:t})}))})),app.get("/cities/:city/:eventId",((e,n)=>{const t=e.params.eventId,r=e.params.city;if(e.isAuthenticated()){const a=e.user;Event.find({city:r,_id:t},((e,t)=>{if(e);else{var r=t[0].tolalCapacity-t[0].Booked;n.render("eventDetails",{foundEvent:t,user:a,remain:r,startDate:numberToDate(String(t[0].startDate)),endDate:numberToDate(String(t[0].endDate))})}}))}else n.redirect("/audiLogin")})),app.get("/analytics/:id",(async function(e,n){if(e.isAuthenticated()){const t=e.params.id;let r,a=0,i=0,o=0,s=0,d=0,u=0;r=await Event.find({_id:t},(function(e,n){if(!e)return n.pop()})),Audiance.find({eventId:t},(function(e,t){e||(t.forEach((function(e){"male"===e.gender&&(a+=1),"female"===e.gender&&(i+=1),e.audiAge>=0&&e.audiAge<=14&&(o+=1),e.audiAge>14&&e.audiAge<=24&&(s+=1),e.audiAge>24&&e.audiAge<=64&&(d+=1),e.audiAge>64&&(u+=1)})),n.render("analytics",{passedAudience:t,male:a,female:i,children:o,teenager:s,middleAged:d,seniorCitizen:u,booking:r[0].Booked,cap:r[0].tolalCapacity,price:r[0].price}))}))}else n.redirect("/login")})),app.get("/collegeAnalytics/:id",(function(e,n){const t=e.params.id;Audiance.find({eventId:t,type:"College"},(function(e,t){n.render("collegeAnalytics",{passedAudience:t})}))})),app.post("/audiDetailsInput",((e,n)=>{new Audiance({audiName:e.body.name,eventId:e.body.id,noOfTickets:e.body.tickets,audiEmail:e.body.audiEmail,audiAge:e.body.audiAge,audiPhNum:e.body.audiPhNum,gender:e.body.gender}).save(),Event.findById(e.body.id,((n,t)=>{t.Booked=Number(t.Booked)+Number(e.body.tickets),t.BookedPer=Number(t.Booked)/t.tolalCapacity*100,t.save(((e,n)=>{}))}));var t=nodemailer.createTransport({service:"gmail",auth:{user:process.env.EMAIL,pass:process.env.EMAIL_PASSWORD}}),r={from:process.env.EMAIL,to:e.body.audiEmail,subject:"Booking Confirmation",text:"Thanks for contacting GRAB MY SEAT"};t.sendMail(r,(function(e,n){})),n.render("audiBookConfirm")})),app.get("/audiregister",(function(e,n){n.render("audiRegister")})),app.post("/audiregister",(function(e,n){Organiser.register({username:e.body.username,name:e.body.name,email:e.body.email,role:e.body.role,audiPhNum:e.body.audiPhNum,gender:e.body.gender,audiAge:e.body.audiAge,prefEvent:e.body.preferred},e.body.password,(function(t,r){t?n.redirect("/audiregister"):passport.authenticate("local")(e,n,(function(){"AUDIENCE"==e.user.role&&n.redirect("/audiLanding");var t=nodemailer.createTransport({service:"gmail",auth:{user:process.env.EMAIL,pass:process.env.EMAIL_PASSWORD}}),r={from:process.env.EMAIL,to:e.body.email,subject:"Succesfully Registered to Grab My Seat",text:"Thanks for registering in GRAB MY SEAT"};t.sendMail(r,(function(e,n){}))}))}))})),app.get("/audiLanding",(function(e,n){if(e.isAuthenticated()){var t=[],r=e.user.prefEvent,a=e.user.name;Event.find({},(function(e,n){e||(t=n).sort(function(e,n){var t=1;"desc"===n&&(t=-1);return function(n,r){return n[e]<r[e]?-1*t:n[e]>r[e]?1*t:0*t}}("BookedPer","desc"))})).then((()=>{Event.find({eventType:r},(function(e,r){e||n.render("audiLanding",{passedEvent:r,arr:t,audiName:a})}))}))}else n.redirect("/audiLogin")})),app.get("/audiLogin",(function(e,n){n.render("audiLogin")})),app.post("/audiLogin",(function(e,n){const t=new Organiser({username:e.body.username,password:e.body.password});e.login(t,(function(t){t||passport.authenticate("local",{failureRedirect:"/audiLogin"})(e,n,(function(){"AUDIENCE"==e.user.role&&n.redirect("/audiLanding")}))}))})),app.get("/register",(function(e,n){n.render("register")})),app.post("/register",(function(e,n){Organiser.register({username:e.body.username,name:e.body.name,email:e.body.email,role:e.body.role},e.body.password,(function(t,r){t?n.redirect("/register"):passport.authenticate("local")(e,n,(function(){"ORGANISER"==e.user.role&&n.redirect("/organiser");var t=nodemailer.createTransport({service:"gmail",auth:{user:process.env.EMAIL,pass:process.env.EMAIL_PASSWORD}}),r={from:process.env.EMAIL,to:e.body.email,subject:"Succesfully Registered as an Organiser in Grab My Seat",text:"Thanks for contacting GRAB MY SEAT"};t.sendMail(r,(function(e,n){}))}))}))})),app.get("/login",((e,n)=>{n.render("login")})),app.post("/login",(function(e,n){const t=new Organiser({username:e.body.username,password:e.body.password});e.login(t,(function(t){t||passport.authenticate("local",{failureRedirect:"/login"})(e,n,(function(){"ORGANISER"==e.user.role&&n.redirect("/organiser")}))}))})),app.get("/collegeEvents",(function(e,n){e.isAuthenticated()?CollegeEvent.find({},(function(e,t){e||n.render("collegeEvents",{foundEvents:t})})):n.redirect("/audiLogin")})),app.post("/collegeBook",(function(e,n){new Audiance({audiName:e.body.name,eventId:e.body.id,audiEmail:e.body.mail,audiAge:e.body.age,audiPhNum:e.body.phnum,type:e.body.type}).save(),n.render("audiBookConfirm")})),app.get("/logout",(function(e,n){e.logout(),n.redirect("/")})),app.get("/audilogout",(function(e,n){e.logout(),n.redirect("/")})),app.get("/events",((e,n)=>{Event.find({},((e,t)=>{e||n.json(t)}))})),app.get("/colEvents",((e,n)=>{CollegeEvent.find({},((e,t)=>{e||n.json(t)}))})),app.get("/search",((e,n)=>{n.render("search")})),app.listen(3e3,(()=>{}));